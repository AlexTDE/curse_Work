{% extends 'testsystem/base.html' %}

{% block title %}–ü—Ä–æ–≥–æ–Ω—ã - –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è UI{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üöÄ –ü—Ä–æ–≥–æ–Ω—ã —Ç–µ—Å—Ç–æ–≤</h2>
        <a href="{% url 'index' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
    
    <div style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω</h3>
        
        <!-- –í—ã–≤–æ–¥ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="padding: 10px; margin-bottom: 15px; border-radius: 5px; 
                {% if message.tags == 'error' %}background-color: #fee; border: 1px solid #fcc; color: #c33;{% endif %}
                {% if message.tags == 'success' %}background-color: #efe; border: 1px solid #cfc; color: #3c3;{% endif %}
                {% if message.tags == 'warning' %}background-color: #fff3cd; border: 1px solid #ffc107; color: #856404;{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
        
        <form id="runForm" method="post" action="{% url 'create_run' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label>–¢–µ—Å—Ç-–∫–µ–π—Å:</label>
                <select id="testcaseSelect" name="testcase_id" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å</option>
                    {% for tc in testcases %}
                        {% if tc.status == 'analyzed' or tc.status == 'ready' %}
                        <option value="{{ tc.id }}" data-status="{{ tc.status }}">
                            {{ tc.id }} - {{ tc.title }} (‚úÖ {{ tc.get_status_display }})
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
                <small style="color: #666; display: block; margin-top: 5px;">
                    –î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã (—Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "Analyzed" –∏–ª–∏ "Ready")
                </small>
                {% if not testcases or not testcases|length %}
                <div style="color: #c33; margin-top: 10px; padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 5px;">
                    ‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å.
                </div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>–¢–µ–∫—É—â–∏–π —Å–∫—Ä–∏–Ω—à–æ—Ç:</label>
                <input type="file" id="actualScreenshot" name="actual_screenshot" 
                       accept="image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,image/tiff" required>
                <small style="color: #666; display: block; margin-top: 5px;">
                    –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: JPG, JPEG, PNG, GIF, BMP, WebP, TIFF (–º–∞–∫—Å. 10 MB)
                </small>
                <div id="fileError" style="color: #c33; margin-top: 5px; display: none;"></div>
                <div id="filePreview" style="margin-top: 10px; display: none;">
                    <img id="previewImage" src="" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
            <button type="submit" class="btn btn-success" id="submitBtn">üì∏ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–≥–æ–Ω</button>
        </form>
    </div>
    
    <hr style="margin: 30px 0; border: none; border-top: 2px solid #f0f0f0;">
    
    <h3 style="margin-bottom: 15px;">–í—Å–µ –ø—Ä–æ–≥–æ–Ω—ã</h3>
    {% if runs %}
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–¢–µ—Å—Ç-–∫–µ–π—Å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü–æ–∫—Ä—ã—Ç–∏–µ</th>
                <th>–î–µ—Ñ–µ–∫—Ç–æ–≤</th>
                <th>–°–æ–∑–¥–∞–Ω</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs %}
            <tr>
                <td>{{ run.id }}</td>
                <td><a href="{% url 'testcase_detail' run.testcase.id %}">{{ run.testcase.title }}</a></td>
                <td><span class="badge badge-{{ run.status }}">{{ run.get_status_display }}</span></td>
                <td>
                    {% if run.coverage is not None %}
                        {{ run.coverage|floatformat:1 }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ run.defects.count }}</td>
                <td>{{ run.started_at|date:"d.m.Y H:i" }}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        {% if run.status == 'queued' or run.status == 'processing' %}
                        <form method="post" action="{% url 'compare_run' run.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-info btn-small">‚ö° –°—Ä–∞–≤–Ω–∏—Ç—å</button>
                        </form>
                        {% endif %}
                        <a href="{% url 'run_detail' run.id %}" class="btn btn-secondary btn-small">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        <form method="post" action="{% url 'delete_run' run.id %}" style="display: inline;" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥–æ–Ω #{{ run.id }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-small">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; text-align: center; padding: 40px;">–ù–µ—Ç –ø—Ä–æ–≥–æ–Ω–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤—ã—à–µ.</p>
    {% endif %}
</div>

<script>
// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
document.getElementById('actualScreenshot').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileError = document.getElementById('fileError');
    const filePreview = document.getElementById('filePreview');
    const previewImage = document.getElementById('previewImage');
    const submitBtn = document.getElementById('submitBtn');
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫
    fileError.style.display = 'none';
    fileError.textContent = '';
    filePreview.style.display = 'none';
    
    if (!file) {
        submitBtn.disabled = false;
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (10 MB)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        fileError.textContent = '–û—à–∏–±–∫–∞: –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (' + (file.size / (1024*1024)).toFixed(2) + ' MB) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π (10 MB)';
        fileError.style.display = 'block';
        submitBtn.disabled = true;
        e.target.value = '';
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–∞
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', 'image/tiff'];
    if (!validTypes.includes(file.type.toLowerCase())) {
        fileError.textContent = '–û—à–∏–±–∫–∞: –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ "' + file.type + '". –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: JPG, JPEG, PNG, GIF, BMP, WebP, TIFF';
        fileError.style.display = 'block';
        submitBtn.disabled = true;
        e.target.value = '';
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    const validExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'tiff', 'tif'];
    const extension = file.name.split('.').pop().toLowerCase();
    if (!validExtensions.includes(extension)) {
        fileError.textContent = '–û—à–∏–±–∫–∞: –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ".' + extension + '". –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ: ' + validExtensions.join(', ').toUpperCase();
        fileError.style.display = 'block';
        submitBtn.disabled = true;
        e.target.value = '';
        return;
    }
    
    // –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const reader = new FileReader();
    reader.onload = function(event) {
        previewImage.src = event.target.result;
        filePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
    
    submitBtn.disabled = false;
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
document.getElementById('runForm').addEventListener('submit', function(e) {
    const testcaseSelect = document.getElementById('testcaseSelect');
    const fileInput = document.getElementById('actualScreenshot');
    const file = fileInput.files[0];
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞
    if (!testcaseSelect.value) {
        e.preventDefault();
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å');
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
    if (!file) {
        e.preventDefault();
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç');
        return false;
    }
    
    // –ï—â–µ —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', 'image/tiff'];
    if (!validTypes.includes(file.type.toLowerCase())) {
        e.preventDefault();
        alert('–û—à–∏–±–∫–∞: –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, JPEG, PNG, GIF, BMP, WebP, TIFF)');
        return false;
    }
    
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        e.preventDefault();
        alert('–û—à–∏–±–∫–∞: –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10 MB');
        return false;
    }
});

// –ü–æ–¥—Å–∫–∞–∑–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤
window.addEventListener('DOMContentLoaded', function() {
    const testcaseSelect = document.getElementById('testcaseSelect');
    const optionsCount = testcaseSelect.options.length - 1; // -1 –¥–ª—è "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å"
    
    if (optionsCount === 0) {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('actualScreenshot').disabled = true;
    }
});
</script>
{% endblock %}
