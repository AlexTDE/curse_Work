{% extends 'testsystem/base.html' %}

{% block title %}–¢–µ—Å—Ç-–∫–µ–π—Å: {{ testcase.title }} - –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è UI{% endblock %}

{% block content %}
<div class="card">
    <style>
        .elements-viewer {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: auto;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            max-height: 80vh;
        }
        .elements-viewer img {
            width: 100%;
            max-height: 80vh;
            object-fit: contain;
            display: block;
        }
        .element-box {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
            border-radius: 6px;
            pointer-events: auto;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .element-box::after {
            content: attr(data-label);
            position: absolute;
            left: 0;
            top: 0;
            transform: translateY(-100%);
            background: rgba(10, 10, 10, 0.75);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px 4px 0 0;
            white-space: nowrap;
        }
        .element-box.active {
            box-shadow: 0 0 0 3px #ff9f43;
            transform: scale(1.02);
            z-index: 5;
        }
        .elements-table tr.element-row.active {
            background: rgba(255, 159, 67, 0.12);
        }
        .element-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
        }
        .chip-button { background: #d1f7c4; color: #1b5e20; }
        .chip-input { background: #cfe2ff; color: #0a58ca; }
        .chip-label { background: #fde2e4; color: #b3163a; }
        .chip-image { background: #fff3cd; color: #a07900; }
        .chip-link { background: #f3e8ff; color: #5c2d91; }
        .chip-unknown { background: #e2e3e5; color: #343a40; }
        .elements-viewer-hint {
            color: #666;
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 25px;
        }
    </style>
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>–¢–µ—Å—Ç-–∫–µ–π—Å: {{ testcase.title }}</h2>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'testcases_list' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            <form method="post" action="{% url 'delete_testcase' testcase.id %}" style="display: inline;" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å \"{{ testcase.title }}\"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å</button>
            </form>
        </div>
    </div>
    
    <div style="margin-bottom: 30px;">
        <p><strong>ID:</strong> {{ testcase.id }}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge badge-{{ testcase.status }}">{{ testcase.get_status_display }}</span></p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ testcase.description|default:"-" }}</p>
        <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ testcase.created_at|date:"d.m.Y H:i" }}</p>
        {% if testcase.created_by %}
        <p><strong>–°–æ–∑–¥–∞–ª:</strong> {{ testcase.created_by.username }}</p>
        {% endif %}
    </div>
    
    {% if testcase.reference_screenshot %}
    <div style="margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px;">–≠—Ç–∞–ª–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç</h3>
        {% if not ocr_ready %}
        <div style="margin-bottom:15px; padding:12px; border-radius:8px; background:#fff3cd; border-left:4px solid #ffc107;">
            <strong>OCR –æ—Ç–∫–ª—é—á–µ–Ω.</strong> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ tesseract –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ PATH, —á—Ç–æ–±—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
        </div>
        {% endif %}
        <img src="{{ testcase.reference_screenshot.url }}" alt="Reference screenshot" style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
        
        {% if elements %}
        <h4 style="margin-bottom: 10px;">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ UI</h4>
        <div class="elements-viewer" id="elements-viewer">
            <img src="{{ testcase.reference_screenshot.url }}" alt="Reference screenshot interactive">
            {% for elem in elements %}
            <div
                class="element-box element-{{ elem.element_type|default:'unknown' }}"
                data-element-id="{{ elem.id }}"
                data-label="{{ elem.text|default:elem.name|default:elem.element_type|default:'element' }}"
                style="
                    left: {% widthratio elem.bbox.x 1 100 %}%;
                    top: {% widthratio elem.bbox.y 1 100 %}%;
                    width: {% widthratio elem.bbox.w 1 100 %}%;
                    height: {% widthratio elem.bbox.h 1 100 %}%;
                "
                title="{{ elem.name|default:'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }} ({{ elem.element_type|default:'unknown' }})"
            ></div>
            {% endfor %}
        </div>
        <p class="elements-viewer-hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ –∏–ª–∏ –Ω–∞ —Ä–∞–º–∫—É, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ–±–ª–∞—Å—Ç—å.</p>
        {% endif %}
    </div>
    {% endif %}
    
    <div style="margin-bottom: 30px;">
        {% if testcase.status == 'new' or testcase.status == 'analyzed' %}
        <form method="post" action="{% url 'analyze_testcase' testcase.id %}" id="analyze-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-info">üîç {% if testcase.status == 'new' %}–ó–∞–ø—É—Å—Ç–∏—Ç—å{% else %}–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å{% endif %} –∞–Ω–∞–ª–∏–∑ –º–∞–∫–µ—Ç–∞</button>
        </form>
        <p style="color: #666; margin-top: 10px;">–ê–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∏—Ö. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è.</p>
        {% if testcase.status == 'analyzed' and elements.count == 0 %}
        <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <p style="color: #856404; margin: 0;"><strong>‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</strong></p>
            <p style="color: #856404; margin: 10px 0 0 0;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>
            <ul style="color: #856404; margin: 10px 0 0 20px;">
                <li>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ (–∫–Ω–æ–ø–∫–∞ –≤—ã—à–µ)</li>
                <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç –Ω–µ –ø—É—Å—Ç–æ–π</li>
                <li>–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Celery –∑–∞–ø—É—â–µ–Ω</li>
                <li>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–∫—Ä–∏–Ω—à–æ—Ç</li>
            </ul>
        </div>
        {% endif %}
        {% else %}
        <p style="color: #666;">–°—Ç–∞—Ç—É—Å: {{ testcase.get_status_display }}</p>
        {% endif %}
    </div>
    
    <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI ({{ elements.count }})</h3>
            {% if elements %}
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="selectAll()" class="btn btn-secondary btn-small">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button type="button" onclick="deselectAll()" class="btn btn-secondary btn-small">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
                <button type="button" onclick="saveApprovedElements()" class="btn btn-primary btn-small">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ</button>
            </div>
            {% endif %}
        </div>
        {% if elements %}
        <div style="margin-bottom: 15px; padding: 12px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">
            <p style="margin: 0; color: #0d47a1;">
                <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –û—Ç–º–µ—Ç—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã —Å–æ–≥–ª–∞—Å–Ω—ã. –û—Å—Ç–∞–ª—å–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã, 
                –∞ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.
            </p>
        </div>
        <table class="table elements-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleAll(this)">
                    </th>
                    <th>ID</th>
                    <th>–¢–∏–ø</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th>
                    <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for elem in elements %}
                <tr class="element-row" data-element-id="{{ elem.id }}">
                    <td>
                        <input type="checkbox" class="element-checkbox" data-element-id="{{ elem.id }}" 
                               checked>
                    </td>
                    <td>#{{ elem.id }}</td>
                    <td>
                        {% with elem.element_type|default:"unknown" as type %}
                        <span class="element-chip chip-{{ type }}">
                            {% if type == 'button' %}üîò{% elif type == 'input' %}‚å®Ô∏è{% elif type == 'label' %}üîñ{% elif type == 'image' %}üñºÔ∏è{% elif type == 'link' %}üîó{% else %}‚ùî{% endif %}
                            {{ type }}
                        </span>
                        {% endwith %}
                    </td>
                    <td><strong>{{ elem.name|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</strong></td>
                    <td>{{ elem.text|default:"‚Äî" }}</td>
                    <td>{{ elem.bbox.w|floatformat:2 }} √ó {{ elem.bbox.h|floatformat:2 }}</td>
                    <td>{{ elem.confidence|floatformat:2 }}</td>
                    <td style="font-size: 12px;">
                        x:{{ elem.bbox.x|floatformat:2 }}, y:{{ elem.bbox.y|floatformat:2 }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #666;">–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞.</p>
        {% endif %}
    </div>
    
    <div>
        <h3 style="margin-bottom: 15px;">–ü—Ä–æ–≥–æ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞ ({{ runs.count }})</h3>
        {% if runs %}
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü–æ–∫—Ä—ã—Ç–∏–µ</th>
                    <th>–î–µ—Ñ–µ–∫—Ç–æ–≤</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for run in runs %}
                <tr>
                    <td>{{ run.id }}</td>
                    <td><span class="badge badge-{{ run.status }}">{{ run.get_status_display }}</span></td>
                    <td>
                        {% if run.coverage is not None %}
                            {{ run.coverage|floatformat:1 }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ run.defects.count }}</td>
                    <td>{{ run.started_at|date:"d.m.Y H:i" }}</td>
                    <td>
                        <a href="{% url 'run_detail' run.id %}" class="btn btn-secondary btn-small">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #666;">–ù–µ—Ç –ø—Ä–æ–≥–æ–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞.</p>
        {% endif %}
    </div>
</div>
<script>
    (function() {
        const rows = document.querySelectorAll('.elements-table .element-row');
        const boxes = document.querySelectorAll('.elements-viewer .element-box');

        if (!rows.length || !boxes.length) {
            return;
        }

        const boxMap = {};
        boxes.forEach(box => {
            boxMap[box.dataset.elementId] = box;
        });

        function setActive(elementId) {
            rows.forEach(r => r.classList.toggle('active', r.dataset.elementId === elementId));
            boxes.forEach(b => b.classList.toggle('active', b.dataset.elementId === elementId));
        }

        rows.forEach(row => {
            row.addEventListener('click', (e) => {
                // –ù–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å
                if (e.target.type === 'checkbox') {
                    return;
                }
                const id = row.dataset.elementId;
                setActive(id);
                const targetBox = boxMap[id];
                if (targetBox) {
                    targetBox.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            });
        });

        boxes.forEach(box => {
            box.addEventListener('click', (event) => {
                event.stopPropagation();
                setActive(box.dataset.elementId);
            });
        });
    })();

    function toggleAll(checkbox) {
        const checkboxes = document.querySelectorAll('.element-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    function selectAll() {
        document.querySelectorAll('.element-checkbox').forEach(cb => cb.checked = true);
        document.getElementById('select-all-checkbox').checked = true;
    }

    function deselectAll() {
        document.querySelectorAll('.element-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('select-all-checkbox').checked = false;
    }

    async function saveApprovedElements() {
        const checkboxes = document.querySelectorAll('.element-checkbox:checked');
        const approvedIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.elementId));
        
        if (approvedIds.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            return;
        }

        const testcaseId = {{ testcase.id }};
        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookie –∏–ª–∏ —Ñ–æ—Ä–º—ã
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrfToken = getCookie('csrftoken') || document.querySelector('#analyze-form [name=csrfmiddlewaretoken]')?.value || '';

        try {
            const response = await fetch(`/testcase/${testcaseId}/approve-elements/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    approved_element_ids: approvedIds
                })
            });

            const data = await response.json();
            
            if (response.ok) {
                alert(`‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${approvedIds.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤. ${data.reclassified || 0} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ.`);
                if (data.retrain_available) {
                    if (confirm('–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏. –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–∏–µ?')) {
                        window.location.reload();
                    }
                } else {
                    window.location.reload();
                }
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        }
    }
</script>
{% endblock %}
