{% extends 'testsystem/base.html' %}
{% load static %}

{% block title %}CI/CD Job: {{ job_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'cicd_dashboard' %}">Дашборд CI/CD</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ job_id }}</li>
                </ol>
            </nav>
        </div>
    </div>

    {% if error %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> {{ error }}
            </div>
            <a href="{% url 'cicd_dashboard' %}" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Вернуться к дашборду
            </a>
        </div>
    </div>
    {% else %}

    <!-- Job Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="bi bi-diagram-3"></i> CI/CD Job: <code>{{ job_id }}</code>
                    </h2>
                    <p class="card-text text-muted">
                        Детальная информация о сборке и результатах прогонов
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Всего прогонов</h6>
                    <h3 class="text-primary">{{ total_runs }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Успешно</h6>
                    <h3 class="text-success">{{ finished_runs }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Ошибки</h6>
                    <h3 class="{% if failed_runs > 0 %}text-danger{% else %}text-muted{% endif %}">
                        {{ failed_runs }}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Success Rate</h6>
                    <h3 class="{% if success_rate >= 80 %}text-success{% elif success_rate >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        {{ success_rate }}%
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Metrics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Среднее покрытие</h6>
                    <h3 class="{% if avg_coverage >= 80 %}text-success{% elif avg_coverage >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        {{ avg_coverage }}%
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Всего дефектов</h6>
                    <h3 class="{% if total_defects > 0 %}text-warning{% else %}text-success{% endif %}">
                        {{ total_defects }}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Критические дефекты</h6>
                    <h3 class="{% if critical_defects > 0 %}text-danger{% else %}text-success{% endif %}">
                        {{ critical_defects }}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Runs Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Прогоны тестов</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Тест-кейс</th>
                                    <th>Статус</th>
                                    <th>Начало</th>
                                    <th>Окончание</th>
                                    <th>Покрытие</th>
                                    <th>SSIM</th>
                                    <th>Дефекты</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for run in runs %}
                                <tr>
                                    <td><code>#{{ run.id }}</code></td>
                                    <td>
                                        <a href="{% url 'testcase_detail' run.testcase.id %}">
                                            {{ run.testcase.title }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if run.status == 'finished' %}
                                        <span class="badge bg-success">Завершено</span>
                                        {% elif run.status == 'failed' %}
                                        <span class="badge bg-danger">Ошибка</span>
                                        {% elif run.status == 'processing' %}
                                        <span class="badge bg-info">В процессе</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ run.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if run.started_at %}
                                        {{ run.started_at|date:"d.m.Y H:i" }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if run.finished_at %}
                                        {{ run.finished_at|date:"d.m.Y H:i" }}
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if run.coverage_metric %}
                                        <span class="badge {% if run.coverage_metric.coverage_percent >= 80 %}bg-success{% elif run.coverage_metric.coverage_percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ run.coverage_metric.coverage_percent|floatformat:1 }}%
                                        </span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if run.reference_diff_score %}
                                        {{ run.reference_diff_score|floatformat:3 }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if run.defects.count > 0 %}
                                        <span class="badge bg-warning text-dark">{{ run.defects.count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'run_detail' run.id %}" class="btn btn-sm btn-primary">
                                            <i class="bi bi-eye"></i> Подробнее
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}
